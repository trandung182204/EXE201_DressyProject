<!DOCTYPE html>
<html class="no-js" lang="zxx">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="keywords" content="Site keywords here">
    <meta name="description" content="#">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>Provider Products</title>

    <link
        href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,300;0,400;0,500;0,700;0,900;1,300;1,400;1,500;1,700;1,900&display=swap"
        rel="stylesheet">
    <link rel="icon" href="img/favicon.png">

    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/font-awesome-all.min.css">
    <link rel="stylesheet" href="css/charts.min.css">
    <link rel="stylesheet" href="css/datatables.min.css">
    <link rel="stylesheet" href="css/jvector-map.css">
    <link rel="stylesheet" href="css/slickslider.min.css">
    <link rel="stylesheet" href="css/jquery-ui.css">
    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="style.css">
</head>

<body id="sherah-dark-light">
    <div class="sherah-body-area">
        <div id="header-container"></div>
        <div id="dashboard-container"></div>

        <section class="sherah-adashboard sherah-show">
            <div class="container">
                <div class="row">
                    <div class="col-12">
                        <div class="sherah-body">
                            <div class="sherah-dsinner">

                                <div class="row mg-top-30">
                                    <div class="col-12 sherah-flex-between">
                                        <div class="sherah-breadcrumb">
                                            <h2 class="sherah-breadcrumb__title">Products</h2>
                                            <ul class="sherah-breadcrumb__list">
                                                <li><a href="#">Home</a></li>
                                                <li class="active"><a href="products.html">Shop</a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <!-- LEFT SIDEBAR (giữ nguyên template) -->
                                    <div class="col-xxl-3 col-lg-4 col-12">
                                        <div class="sherah-product-sidebar sherah-default-bg mg-top-30">
                                            <h4 class="sherah-product-sidebar__title sherah-border-btm">Product
                                                Categories</h4>
                                            <ul class="sherah-product-sidebar__list">
                                                <li><a href="#"><span><i
                                                                class="fa-solid fa-chevron-right"></i>All</span></a>
                                                </li>
                                            </ul>
                                        </div>

                                        <div class="sherah-product-sidebar sherah-default-bg mg-top-30">
                                            <h4 class="sherah-product-sidebar__title sherah-border-btm">Price Range</h4>
                                            <div class="price-filter">
                                                <div class="price-filter-inner">
                                                    <div id="slider-range"></div>
                                                    <div class="price_slider_amount">
                                                        <div class="label-input">
                                                            <span>Range:</span>
                                                            <input type="text" id="amount" name="price"
                                                                placeholder="Add Your Price" />
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="sherah-product-sidebar sherah-default-bg mg-top-30">
                                            <h4 class="sherah-product-sidebar__title sherah-border-btm">Product Brands
                                            </h4>
                                            <ul class="sherah-product-sidebar__list">
                                                <li><a href="#"><span><i
                                                                class="fa-solid fa-chevron-right"></i>All</span></a>
                                                </li>
                                            </ul>
                                        </div>

                                        <div class="sherah-product-sidebar sherah-default-bg mg-top-30">
                                            <h4 class="sherah-product-sidebar__title sherah-border-btm">Size</h4>
                                            <ul class="sherah-product-sidebar__size">
                                                <li><a class="sherah-border" href="#">All</a></li>
                                            </ul>
                                        </div>
                                    </div>

                                    <!-- RIGHT CONTENT -->
                                    <div class="col-xxl-9 col-lg-8 col-12">
                                        <div class="sherah-breadcrumb__right mg-top-30">
                                            <div class="sherah-breadcrumb__right--first">
                                                <div class="sherah-header__form sherah-header__form--product">
                                                    <form class="sherah-header__form-inner" action="#"
                                                        onsubmit="return false;">
                                                        <button class="search-btn" type="button">
                                                            <svg width="24" height="25" viewBox="0 0 24 25" fill="none"
                                                                xmlns="http://www.w3.org/2000/svg">
                                                                <path
                                                                    d="M15.6888 18.2542C10.5721 22.0645 4.46185 20.044 1.80873 16.2993C-0.984169 12.3585 -0.508523 7.01726 2.99926 3.64497C6.41228 0.362739 11.833 0.112279 15.5865 3.01273C19.3683 5.93475 20.8252 11.8651 17.3212 16.5826C17.431 16.6998 17.5417 16.8246 17.6599 16.9437C19.6263 18.9117 21.5973 20.8751 23.56 22.8468C24.3105 23.601 24.0666 24.7033 23.104 24.9575C22.573 25.0972 22.1724 24.8646 21.8075 24.4988C19.9218 22.6048 18.0276 20.7194 16.1429 18.8245C15.9674 18.65 15.8314 18.4361 15.6888 18.2542ZM2.39508 10.6363C2.38758 14.6352 5.61109 17.8742 9.62079 17.8977C13.6502 17.9212 16.9018 14.6914 16.9093 10.6597C16.9169 6.64673 13.7046 3.41609 9.69115 3.39921C5.66457 3.38232 2.40259 6.61672 2.39508 10.6363Z">
                                                                </path>
                                                            </svg>
                                                        </button>
                                                        <input id="searchInput" name="s" value="" type="text"
                                                            placeholder="Search products...">
                                                    </form>
                                                </div>
                                                <p id="resultCount">Loading...</p>
                                            </div>
                                        </div>

                                        <div class="tab-content" id="nav-tabContent">
                                            <div class="tab-pane fade show active" id="tab_1" role="tabpanel">
                                                <!-- ✅ product-list phải là ROW -->
                                                <div class="row" id="product-list"></div>

                                                <div class="row mg-top-40">
                                                    <div class="sherah-pagination">
                                                        <ul class="sherah-pagination__list">
                                                            <li class="sherah-pagination__button"><a href="#"><i
                                                                        class="fas fa-angle-left"></i></a></li>
                                                            <li class="active"><a href="#">01</a></li>
                                                            <li><a href="#">02</a></li>
                                                            <li><a href="#">03</a></li>
                                                            <li class="sherah-pagination__button"><a href="#"><i
                                                                        class="fas fa-angle-right"></i></a></li>
                                                        </ul>
                                                    </div>
                                                </div>

                                            </div>
                                        </div>

                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Scripts -->
    <script src="js/jquery.min.js"></script>
    <script src="js/jquery-migrate.js"></script>
    <script src="js/jquery-ui.min.js"></script>
    <script src="js/popper.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/charts.js"></script>
    <script src="js/datatables.min.js"></script>
    <script src="js/circle-progress.min.js"></script>
    <script src="js/jquery-jvectormap.js"></script>
    <script src="js/jvector-map.js"></script>
    <script src="js/main.js"></script>

    <script>
        // Slider UI (giữ lại)
        var dt = $.noConflict(true);
        var jq = $.noConflict();
        jq(function () {
            jq("#slider-range").slider({
                range: true,
                min: 0,
                max: 500,
                values: [100, 300],
                slide: function (event, ui) {
                    jq("#amount").val("$" + ui.values[0] + " - $" + ui.values[1]);
                }
            });
            jq("#amount").val("$" + jq("#slider-range").slider("values", 0) + " - $" + jq("#slider-range").slider("values", 1));
        });
    </script>

    <script>
        async function loadLayout() {
            const headerRes = await fetch("header.html");
            document.getElementById("header-container").innerHTML = await headerRes.text();

            const dashRes = await fetch("dashboard.html");
            document.getElementById("dashboard-container").innerHTML = await dashRes.text();

            // template init
            if (typeof initSherahLayout === "function") initSherahLayout();
        }
        loadLayout();
    </script>

    <script>
        // ✅ đổi lại cho đúng cổng backend của bạn (bạn đang dùng 8080)
        const API_BASE = "http://localhost:5135";

        let allProducts = [];

        function getToken() {
            return localStorage.getItem("access_token");
        }

        function normalizeProducts(payload) {
            // payload có thể là array hoặc object {data: array}
            if (Array.isArray(payload)) return payload;
            if (payload && Array.isArray(payload.data)) return payload.data;
            if (payload && payload.success && Array.isArray(payload.data)) return payload.data;
            return [];
        }

        function safeText(v) {
            return (v === null || v === undefined) ? "" : String(v);
        }

        function formatMoney(v) {
            if (v === null || v === undefined || v === "") return "";
            const n = Number(v);
            if (Number.isNaN(n)) return safeText(v);
            return n.toLocaleString("vi-VN") + " ₫";
        }

        async function loadProviderProducts() {
            const token = getToken();
            if (!token) {
                alert("Bạn chưa đăng nhập");
                window.location.href = "login.html";
                return;
            }

            const container = document.getElementById("product-list");
            const resultCount = document.getElementById("resultCount");

            container.innerHTML = `<div class="col-12"><p>Đang tải sản phẩm...</p></div>`;
            resultCount.textContent = "Loading...";

            try {
                const res = await fetch(`${API_BASE}/api/provider/products`, {
                    method: "GET",
                    headers: {
                        "Authorization": "Bearer " + token,
                        "Content-Type": "application/json"
                    }
                });

                if (res.status === 401) {
                    const text = await res.text();
                    alert("401 Unauthorized: " + text);
                    localStorage.removeItem("access_token");
                    window.location.href = "login.html";
                    return;
                }


                if (!res.ok) {
                    const text = await res.text();
                    throw new Error(text || "Không thể tải sản phẩm");
                }

                const payload = await res.json();
                allProducts = normalizeProducts(payload);

                renderProducts(allProducts);
            } catch (err) {
                console.error(err);
                container.innerHTML = `<div class="col-12"><p style="color:red;">Lỗi: ${safeText(err.message)}</p></div>`;
                resultCount.textContent = "0 results";
            }
        }

        function renderProducts(products) {
            const container = document.getElementById("product-list");
            const resultCount = document.getElementById("resultCount");
            container.innerHTML = "";

            if (!products || products.length === 0) {
                container.innerHTML = `<div class="col-12"><p>Chưa có sản phẩm nào</p></div>`;
                resultCount.textContent = "Showing 0 results";
                return;
            }

            resultCount.textContent = `Showing 1–${products.length} of ${products.length} results`;

            products.forEach(p => {
                // ✅ Ưu tiên field theo DTO backend (thumbnailUrl, minPricePerDay, categoryName)
                const id = p.id ?? p.productId ?? "";
                const name = p.name ?? "Unnamed";
                const category = p.categoryName ?? "";
                const thumb = p.thumbnailUrl || p.thumbnail || "img/product-img1.png";
                const price = p.minPricePerDay ?? p.pricePerDay ?? p.price ?? null;
                const status = p.status ?? "";

                container.innerHTML += `
          <div class="col-xxl-4 col-lg-6 col-md-6 col-12">
            <div class="sherah-product-card sherah-product-card__v2 sherah-default-bg sherah-border mg-top-30">
              <div class="sherah-product-card__img">
                <img src="${thumb}" alt="${safeText(name)}" onerror="this.src='img/product-img1.png'">
              </div>

              <div class="sherah-product-card__content sherah-dflex-column sherah-flex-gap-5">
                <h4 class="sherah-product-card__title">
                  <a href="product-detail.html?id=${id}" class="sherah-pcolor">${safeText(name)}</a>
                </h4>

                <div class="sherah-product__bottom">
                  <div class="sherah-product__bottom--single">
                    <h5 class="sherah-product-card__price">
                      ${price !== null ? formatMoney(price) + " / ngày" : ""}
                    </h5>
                    <div class="sherah-product-card__meta">
                      ${category ? `<span>Category: <b>${safeText(category)}</b></span><br>` : ""}
                      <span>Status: <b>${safeText(status)}</b></span>
                    </div>
                  </div>

                  <a href="product-detail.html?id=${id}" class="sherah-btn default">Detail</a>
                </div>
              </div>
            </div>
          </div>
        `;
            });
        }

        function setupSearch() {
            const input = document.getElementById("searchInput");
            if (!input) return;

            input.addEventListener("input", () => {
                const q = input.value.trim().toLowerCase();
                if (!q) return renderProducts(allProducts);

                const filtered = allProducts.filter(p =>
                    (p.name || "").toLowerCase().includes(q) ||
                    (p.categoryName || "").toLowerCase().includes(q) ||
                    (p.status || "").toLowerCase().includes(q)
                );

                renderProducts(filtered);
            });
        }

        document.addEventListener("DOMContentLoaded", () => {
            setupSearch();
            loadProviderProducts();
        });
    </script>
</body>

</html>